# /docker-compose.yml

# La directiva 'version' es obsoleta en las versiones modernas de Compose
# version: '3.8'

services:
  # --- Servicio para el Broker MQTT (Mosquitto) ---
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    restart: unless-stopped

  # --- Servicio para InfluxDB ---
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=password123
      - DOCKER_INFLUXDB_INIT_ORG=utp
      - DOCKER_INFLUXDB_INIT_BUCKET=sensors
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=mySuperSecretToken123!
    restart: unless-stopped

  # --- Servicio del Servidor de Tiempo (Cristian) ---
  time-server:
    build: .
    container_name: time-server
    depends_on:
      - mqtt-broker
    command: "node time-server/time-server.js"
    restart: on-failure

  # --- Servicio del Coordinador de Bloqueo (Mutex) ---
  #lock-coordinator:
  #  build: .
  # container_name: lock-coordinator
  # depends_on:
  #    - mqtt-broker
#    command: "node lock-coordinator/lock-coordinator.js"
#    environment:
#      # ID de Proceso para Exclusión Mutua
#      - PROCESS_ID=2
#      # --- NUEVO: Configuración de Elección ---
#      - PROCESS_PRIORITY=10 # El ID más alto, es el líder
#      - ELECTION_PARTICIPANTS=10:lock-coordinator,6:publisher-2,5:publisher-1
#    restart: on-failure

  # --- Servicio para el Publicador (Sensor 1) ---
  publisher-1:
    build: .
    container_name: publisher-1
    depends_on:
      - mqtt-broker
      - time-server # Depende del servidor de tiempo
    command: "node publisher/publisher.js"
    environment:
      - DEVICE_ID=sensor-1
      - CLOCK_DRIFT_RATE=500
      - PROCESS_ID=0
      # --- NUEVO: Configuración de Elección ---
      - PROCESS_PRIORITY=10 # El ID más bajo
      - ELECTION_PARTICIPANTS=sensor-1:10,sensor-2:20,sensor-3:30,sensor-4:40,sensor-5:50
    volumes:
      - ./wal_logs:/app/publisher  # ← FASE 3: Persistir WAL en disco host
    restart: on-failure

  # --- Servicio para el Publicador (Sensor 2) ---
  publisher-2:
    build: .
    container_name: publisher-2
    depends_on:
      - mqtt-broker
      - time-server # Depende del servidor de tiempo
    command: "node publisher/publisher.js"
    environment:
      - DEVICE_ID=sensor-2
      - CLOCK_DRIFT_RATE=-500
      - PROCESS_ID=1
      # --- NUEVO: Configuración de Elección ---
      - PROCESS_PRIORITY=20 # ID intermedio
      - ELECTION_PARTICIPANTS=sensor-1:10,sensor-2:20,sensor-3:30,sensor-4:40,sensor-5:50
    volumes:
      - ./wal_logs:/app/publisher  # ← FASE 3: Persistir WAL en disco host
    restart: on-failure

    # --- Servicio para el Publicador (Sensor 3) ---
  publisher-3:
    build: .
    container_name: publisher-3
    depends_on:
      - mqtt-broker
      - time-server # Depende del servidor de tiempo
    command: "node publisher/publisher.js"
    environment:
      - DEVICE_ID=sensor-3
      - CLOCK_DRIFT_RATE=-500
      - PROCESS_ID=2
      # --- NUEVO: Configuración de Elección ---
      - PROCESS_PRIORITY=30 # ID intermedio
      - ELECTION_PARTICIPANTS=sensor-1:10,sensor-2:20,sensor-3:30,sensor-4:40,sensor-5:50
    volumes:
      - ./wal_logs:/app/publisher  # ← FASE 3: Persistir WAL en disco host
    restart: on-failure

    # --- Servicio para el Publicador (Sensor 4) ---
  publisher-4:
    build: .
    container_name: publisher-4
    depends_on:
      - mqtt-broker
      - time-server # Depende del servidor de tiempo
    command: "node publisher/publisher.js"
    environment:
      - DEVICE_ID=sensor-4
      - CLOCK_DRIFT_RATE=-500
      - PROCESS_ID=3
      # --- NUEVO: Configuración de Elección ---
      - PROCESS_PRIORITY=40 # ID intermedio
      - ELECTION_PARTICIPANTS=sensor-1:10,sensor-2:20,sensor-3:30,sensor-4:40,sensor-5:50
    volumes:
      - ./wal_logs:/app/publisher  # ← FASE 3: Persistir
    restart: on-failure

    # --- Servicio para el Publicador (Sensor 5) ---
  publisher-5:
    build: .
    container_name: publisher-5
    depends_on:
      - mqtt-broker
      - time-server # Depende del servidor de tiempo
    command: "node publisher/publisher.js"
    environment:
      - DEVICE_ID=sensor-5
      - CLOCK_DRIFT_RATE=-500
      - PROCESS_ID=4
      # --- NUEVO: Configuración de Elección ---
      - PROCESS_PRIORITY=50 # ID intermedio
      - ELECTION_PARTICIPANTS=sensor-1:10,sensor-2:20,sensor-3:30,sensor-4:40,sensor-5:50
    volumes:
      - ./wal_logs:/app/publisher  # ← FASE 3: Persistir WAL en disco host
    restart: on-failure


  # --- Servicio para el Suscriptor de Persistencia ---
  persistence-subscriber:
    build: .
    container_name: persistence-subscriber
    depends_on:
      - mqtt-broker
      - influxdb
    command: "node subscriber/persistence-subscriber.js"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=mySuperSecretToken123!
      - INFLUXDB_ORG=utp
      - INFLUXDB_BUCKET=sensors
      - PROCESS_ID=2
    restart: on-failure

#
  # --- Suscriptores de ejemplo (sin cambios, pero dependen del broker) ---
#  unicast-subscriber:
#    build: .
#    container_name: unicast-subscriber
#    depends_on:
#      - mqtt-broker
#    command: "node subscriber/unicast.js"
#    environment:
#      - DEVICE_ID=sensor-001
#    restart: on-failure

#  multicast-subscriber:
#    build: .
#    container_name: multicast-subscriber
#    depends_on:
#      - mqtt-broker
#    command: "node subscriber/multicast.js"
#    restart: on-failure

#  broadcast-subscriber:
#    build: .
#    container_name: broadcast-subscriber
#    depends_on:
#      - mqtt-broker
#    command: "node subscriber/broadcast.js"
#    restart: on-failure

#  monitor:
#    build: .
#    container_name: monitor
#    depends_on:
#      - mqtt-broker
#    command: "node subscriber/monitor.js"
#    restart: on-failure
#
  # --- Servicio para el Monitor Web (Frontend) ---
  web-monitor:
    image: nginx:1.25-alpine
    container_name: web-monitor
    ports:
      - "8080:80"
    volumes:
      - ./web-monitor:/usr/share/nginx/html:ro
    depends_on:
      - mqtt-broker
    restart: unless-stopped

# --- Definición del volumen para InfluxDB ---
volumes:
  influxdb_data:
